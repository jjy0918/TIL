# 6. 데이터 압축

## 6.1 페이지 압축

- `페이지 압축`은 `Transparent Page Compression`이라고 불린다.
  - MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장된다.
  - MySQL 서버가 디스크에서 데이터 페이지를 읽어올 때 압축이 해제된다.
- 버퍼 풀에 데이터 페이지가 한 번 적재되면, InnoDB 스토리지 엔진은 압축이 해제된 상태로만 데이터 페이지를 관리한다.
- 즉, MySQL 서버에서는 압축 여부와 관계 없이 투명(Transparent)하게 작동한다.
- 데이터 압축 시 결과 용량이 얼마나 될지는 테이블을 동일한 크기의 페이지로 통일해야 해서 예측이 불가능하다.
  - 페이지 압축 기능은 운영체제별로 특정 버전의 파일 시스템에서만 지원되는 펀치 홀(Punch hole)이라는 기능을 사용한다.
  - 펀치 홀 기능을 통해 실제 디스크에 적재된 용량과 데이터 페이지에 사용중인 용량이 다르다.
  - 16KB인 데이터를 압축하여 7KB로 만들었다면 실제 디스크에는 7KB만 적재도지만, 운영체제는 펀치홀 9KB를 포함하여 16KB로 인식한다.
- 페이지 압축의 경우 파일 시스템 관련 명령어가 펀치 홀 기능을 지원하지 못하는 등 문제가 발생할 수 있기 때문에 많이 사용되지 않는 상태다.
- 페이지 압축을 하기 위해서는 테이블 생성, 변경 시 `COMPRESSION` 옵션을 사용하면 된다.

## 6.2 테이블 압축

- `테이블 압축`은 운영체제나 하드웨어에 대한 제약 없이 사용할 수 있기 때문에 자주 사용된다.
- 테이블 압축은 디스크의 데이터 파일 크기를 줄일 수 있기 때문에 그만큼의 이득이 존재한다.
- 하지만 단점 몇 가지가 있다.
  - 버퍼 풀 공간 활용률이 낮음
  - 쿼리 처리 성능이 낮음
  - 빈번한 데이터 변경 시 압축률이 떨어짐

### 6.2.1 압축 테이블 생성

- 테이블 압축을 사용하기 위해서는 압축하려는 테이블이 별도의 테이블 스페이스를 사용해야 한다.
  - `innodb_file_per_table` 시스템 변수를 `ON`으로 설정한 상태에서 테이블이 생성되어야 한다.
- 테이블 생성 시 `ROW_FORMAT=COMPRESSED` 옵션을 명시해주어야 한다.
  - `KEY_BLOCK_SIZE` 옵션을 이용하여 압축된 페이지의 타깃 크기(2의 배수)를 명시할 수 있다.
- 테이블 압축 시 KEY_BLOCK_SIZE에서 설정한 값 만큼 저장될 페이지의 크기로 설정한다.
  - 압축 결과가 KEY_BLOCK_SIZE보다 작은 경우 그대로 저장한다.
  - 압축 결과가 KEY_BLOCK_SIZE보다 큰 경우 나눠서 크기에 맞게 저장한다.
- KEY_BLOCK_SIZE 크기가 잘못 설정될 경우 MySQL 처리 성능이 급격히 떨어질 수 있기 때문에 주의해야 한다.

### 6.2.2 KEY_BLOCK_SIZE 결정

- 테이블 압축에서 가장 중요한 부분은 압축 결과를 예측하여 KEY_BLOCK_SIZE를 결정하는 것이다.
- 테이블 압축을 적용하기 전에 KEY_BLOCK_SIZE를 4KB 또는 8KB로 생성하여 샘플 데이터를 저장한 후 판단하는 것이 좋다.
- 테스트할 때 주의할 점은 압축 실패율이 높다고 하여 압축을 사용하지 말아야 한다는 것이 아니라는 점이다.

### 6.2.3 압축된 페이지의 버퍼 풀 적재 및 사용

- InnoDB는 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재하면, 압축된 상태와 압축이 해제된 상태 2개 버전을 관리한다.
- 디스크에서 읽은 상태 그대로의 데이터 페이지를 관리하는 LRU 리스트와 압축 해제된 페이지를 관리한느 Unzip_LRU 리스트를 별도 관리한다.
- 즉, InnoDB는 압축된 데이터 테이블에 대해서 버퍼 풀의 공간을 이중으로 사용함으로써 메모리를 낭비하는 효과를 가진다.
- 압축된 데이터를 조회하거나 수정할 때 압축을 해제해야 하기 때문에 CPU를 상대적으로 많이 소모한다.
