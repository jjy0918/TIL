# 4.2 카프카 프로듀서

## 4.2.1 acks 옵션

- 카프카 프로듀서는 acks 옵션을 0, 1, all(또는 -1) 값을 가질 수 있다.
- 복제 개수가 1개인 경우, acks 옵션에 따른 성능 변화느 크지 않지만 2대 이상인 경우 acks 별 차이가 존재한다.

### acks=0

- 이 옵션은 프로듀서가 리더 파티션으로 데이터를 전송했을 때 데이터가 저장되었는지 확인하지 않는다.
- 기본적으로 리더 파티션은 데이터 저장 후 오프셋 값을 리턴하지만, 이 옵션은 해당 데이터를 받지 않기 때문에 알 수 없다.
- 데이터 전송 실패 시 재시도하는 reties 옵션의 경우 acks=0으로 설정되어 있다며느 전송하자 마자 저장되었다고 판단하기 때문에 의미가 없다.
- 데이터 저장 여부를 확인하지 않기 때문에 다른 옵션들 보다 속도가 빠르다.
- 다만, 데이터 유실이 발생한 경우 알 수 없다.
- 데이터 일부가 유실되더라도 전송 속도가 중요한 경우 이 옵셥을 사용하면 좋다.

### acks=1

- 이 옵션은 프로듀서가 리더 파티션에만 데이터가 정상 적재되었는지 확인한다.
- 리더 파티션에 적재되지 않았다면, 재시도를 한다.
- 그렇기 때문에 리더 파티션에 적재됨은 보장된다.
- 다만, 리더 파티션에 적재됨만 보장하기 때문에 동기화 여부는 알 수 없다.
  - 동기화 되기 전 리더 파티션에 장애가 발생하면 데이터 유실이 발생할 수 있다.
- 리더 파티션에 데이터 적재 여부를 확인하기 때문에 akcs=0 보다는 느리다.

### acks=all or acks=-1

- 이 옵션은 프로듀서가 리더 파티션에 데이터를 전송할 경우 리더 파티션과 팔로워 파티션(ISR 그룹)에 모두 정상적으로 적재되었는지 확인한다.
- 그렇기 때문에 0과 1 보다 느리다.
- 팔로워 파티션에 적재됨을 판단하기 때문에 min.insync.replicas 옵션에 따라 데이터 안정성이 달라진다.
  - min.insync.replicas은 데이터 적재를 확인하기 위한 ISR 그룹의 최소 파티션 개수이다.
  - min.insync.replicas 값이 1이라면, ISR 그룹 중 최소 1개 이상의 파티션에 적재됨을 확인한다.
  - min.insync.replicas 값이 1인 경우 acks=1과 동작이 동일하다.(즉 2 이상부터 의미가 있다.)
  - min.insync.replicas 옵션의 경우 복제 개수도 고려해야 한다.
    - 장애가 발생하여 min.insync.replicas 개수 보다 복제 개수가 작아지는 경우 에러가 발생할 수 있다.
    - 즉, 브로커의 개수와 동일하게 설정하면 안된다.
- 일반적으로 데이터를 안정적으로 사용하기 위해서 브로커가 3대라면 복제 개수는 3, min.insync.replicas=2로 설정하고 acks=all로 설정하는 것이 좋다.

## 4.2.2 멱등성(idempotence) 프로듀서

- 멱등성이란 여러 번 연산을 수행해도 동일한 결과를 나타내는 것을 의미한다.
- 카프카에서 멱등성 프로듀서란 동일한 데이터를 여러 번 전송해도 클러스터에 한 번만 저장됨을 의미한다.
- `enable.idempotence` 을 `true`로 설정하면, 멱등성 프로듀서로 동작하게 만들 수 있다.(기본 값은 false)
- 멱등성 프로듀서는 기본적으로 브로커로 데이터 전달 시 PID, sequence number를 같이 전달하여 단 한 번만 데아터를 적재한다.
  - 즉, 같은 데이터라도 프로세스가 새로 실행되면 다른 데이터라고 판단한다.
- 멱등성 프로듀서는 기본적으로 retires 값이 Integer.MAX_VALUE이고, acks 값은 all이다.

## 4.2.3 트랜잭션(transaction) 프로듀서

- 트랜잭션 프로듀서는 데이터 저장 시 모든 데이터에 대해 동일한 원자성을 만족시키기 위해 사용된다.
  - 즉, 전체 데이터가 저장되거나 저장되지 않는다.
- 트랜잭션 프로듀서를 사용하기 위해서는 `enable.idempotence = true`, `tractional.id = 임의의 String`, `isolation.level = read_committed` 로 정의해야 한다.
  - 위 옵션을 설정하게 되면, 프로듀서와 컨슈머는 트랜잭션이 완료된 경우에만 데이터를 쓰고 읽는다.
- 트랜잭션 프로듀서는 레코드뿐만 아니라 트랜잭션 시작과 끝을 표현하는 `트랜잭션 레코드`를 한 개 더 보낸다.
  - 트랜잭션 컨슈머는 트랜잭션 레코드를 통해 트랜잭션이 완료된 데이터만 가져간다.
  - 트랜잭션 레코드는 트랜잭션이 끝난 상태를 표시하는 정보만 가지고 있다.
  - 트랜잭션 레코드도 레코드의 특성을 가지고 있기 때문에 파티션에 저장되어 오프셋을 한 개 더 차지한다.
