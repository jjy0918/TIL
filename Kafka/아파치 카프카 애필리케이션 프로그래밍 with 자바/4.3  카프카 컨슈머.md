# 4.3 카프카 컨슈머

## 4.3.1 멀티 스레드 컨슈머

- 카프카 처리량을 늘리기 위해 파티션과 컨슈머 개수를 늘려서 운영할 수 있다.
- 파티션 개수와 컨슈머 개수를 동일하게 맞추어 병렬로 처리하면 처리량을 늘릴 수 있다.
- 파티션 개수가 n개라면 동일 컨슈머 그룹으로 묶인 컨슈머 프로세스 n개 or 1개 프로세스에 n개의 스레드로 운영할 수 있다.
- 멀티 스레드를 이용하여 컨슈머를 구성하는 방법은 `멀티 워커 스레드 전략`과 `컨슈머 멀티 스레드 전략`이 있다.

### 멀티 워커 스레드 전략

- 멀티 워커 스레드 전략은 컨슈머 스레드는 1개만 실행하고, 데이터를 처리하는 워커 스레드를 여러 개 실행하는 전략이다.
- 한번 poll을 받고, 그 데이터를 워커 스레드를 통해 처리한다.
- 속도적으로 이점을 얻을 수 있지만, 몇 가지 주의 사항이 있다.
  1. 데이터 처리가 끝나지 않아도 커밋을 하기 때문에 리벨런싱, 컨슈머 장애 시 데이터 유실이 발생할 수 있다.
  2. 스레드마다 처리 속도가 다르기 때문에 레코드 처리 역전형상이 발생할 수 있다.(데이터 처리 순서 변경)

### 컨슈머 멀티 스레드 전략

- 토픽의 파티션 개수 만큼 컨슈머 스레드 개수를 늘려 운영하는 전략이다.


## 4.3.2 컨슈머 랙(LAG)

- 컨슈머 랙은 토픽의 최신 오프셋(LOG-END-OFFSET)과 컨슈머 오프셋(CURRENT-OFFSET) 간의 차이를 말한다.
- 프로듀서가 보내는 데이터양이 컨슈머의 데이터 처리량보다 많은 경우 컨슈머 랙은 늘어난다.
- 컨슈머 랙을 모니터링 하는 것은 카프카 데이터 파이프라인 운영 시 핵심적인 역할을 한다.
  - 예를 들어, 데이터 전송량이 동일한데 특정 파티션만 랙이 늘어난다면 해당 파티션 컨슈머에 이슈가 발생했음을 의미한다.
- 컨슈머 랙을 확인하는 방법은 3가지가 있다.
    1. 카프카 명령어 사용
       - kafaka-consumer-groups.sh 명령어를 사용하여 컨슈머 상태 확인
    2. 컨슈머 metrics() 메서드 사용
       - KafkaConsumer 인스턴스이 metrics() 메서드를 활용하여 랙 지표를 확인할 수 있다.
       - 이 경우, 컨슈머가 정상적으로 동작하는 경우만 알 수 있다는 단점이 있다.
    3. 외부 모니터링 툴 사용
       - Datadog, Confluent Control Center와 같은 모니터링 툴 사용

## 4.3.3 카프카 배포 프로세스

### 중단 배포

- 중단 배포는 컨슈머 애플리케이션이 완전히 종료된 이후 배포하는 방식이다.
- 한정된 서버 자원을 운영하는 기업에 적합하다.
- 기존 서버는 중단되기 때문에 컨슈머 랙이 늘어난다.
- 중단 배포를 하는 경우 새로운 로직이 적용된 신규 애플리케이션 실행 전후를 명확하게 나눌 수 있다.

### 무중단 배포

- 무중단 배포에는 롤링, 블루/그린, 카나리 배포가 있다.

#### 롤링

- 일반적인 배포 방법
- 단순하게 서버를 배포하는 방법.
- 기존 버전에서 새로운 버전으로 점진적 배포
- 배포할 인스턴스를 로드밸런서에서 제거한 다음 배포한다. 그 이후 다시 로드밸런서에 등록한다.
- 장점
  - 인스턴스 차례로 배포하기 때문에 롤백이 쉽다.
  - 배포 방식이 간단하다.
- 단점
  - 새 버전 배포 시 배포중인 인스턴스가 로드밸런서에서 제거되기 때문에 다른 인스턴스로 트래픽이 몰릴 수 있다.
  - 여러 버전이 혼재되어 있기 때문에 호환성 문제를 야기시킬 수 있다.

![image](https://user-images.githubusercontent.com/29697310/175809249-af2dc59d-d8ae-408e-b106-c96919097142.png)

#### 블루-그린

- 블루: 이전 버전
- 그린: 새로운 버전
- 블루 버전과 그린 버전을 모두 띄우고, 그린이 준비가 완료되었다면 블루를 종료시킨다.
- 장점
  - 서비스의 중단점이 없기 때문에 버전 혼재에 따른 문제가 없다.
  - 블루가 남겨져 있기 때문에 롤백이 쉽다.
- 단점
  - 리소스가 두 배로 필요하다는 단점이 있다.

![image](https://user-images.githubusercontent.com/29697310/175809259-a8e9cb52-ead6-4e60-8d25-d3f4ea2d5faf.png)

#### 카나리

- 릴리즈 버전을 하나씩 올려서 정상 작동하는지 확인한 후 기존 버전을 종료한다.
- 이러한 방식을 반복하여 점진적 배포한다.
- 카나리 배포를 하기 위해서 테스트 그룹의 크기나 그룹에 포함될 사람등을 지정해야 한다.
- 배포 후 지속적 모니터링 후 결과가 만족스러우면 점진적 배포를 한다.
- 장점
  - 문제 상황을 빠르게 감지할 수 있다.
  - 서로 다른 버전에 대한 테스트가 가능하다.
  - 블루-그린 방식보다 저렴하다.
- 단점
  - 네트어크 트래픽 제어 부담이 있다.
  
![image](https://user-images.githubusercontent.com/29697310/175809263-99d503f4-180f-400f-ad0e-df4a35bd63b5.png)

> https://www.koyeb.com/blog/blue-green-rolling-and-canary-continuous-deployments-explained
