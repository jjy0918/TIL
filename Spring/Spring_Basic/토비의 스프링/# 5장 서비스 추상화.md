# 5장 서비스 추상화

## 5.1 사용자 레벨 관리 기능 추가

- 비즈니스 로직 요구사항
  - 사용자 레벨은 BASIC, SILVER, GOLD
  - 처음 가입 시 BASIC, 이후 한 단계씩 업그레이드
  - 가입 후 50회 이상 로그인하면 BASIC -> SILVER
  - SILVER에서 30번 이상 추천 받으면 SILVER -> GOLD
  - 레벨 변경은 주기를 가지며 일괄적으로 진행됨.(변경 작업 전에 조건이 충족되어도 변경 X)

### 5.1.1 필드 추가

- 사용자의 레벨은 BASIC, SILVER, GOLD로 구성되어 있지만 이 값을 DB의 varchar로 선언하는 것은 좋지 않다.
  - 각 레벨을 코드화하여 숫자로 넣는 것이 간단하다.
- 각 레벨을 표현하기 위해 자바에서는 숫자와 같은 의미 없는 값 보다는 enum 을 사용하는 것이 좋다.
  - enum을 사용할 경우 DB에 저장될 수 있도록 enum을 각 숫자로 변환시켜주어야 한다.

```java
// 비추천
class User {
    private static final int BASIC = 1;
    private static final int SILVER = 2;
    private static final int GOLD = 3;
    ...
}

// 추천
public enum Level {
    BASIC(1), SILVER(2), GOLD(3);
    ...
}
```

### 5.1.2 사용자 수정 기능 추가

- 사용자 정보 수정용 update 메소드

```java
public void update(User user) {
    this.jdbcTemplate.update(
        "update user set name = ?, password = ?, level = ?, login = ?," +
        "recommend = ? where id = ?",
        user.getName(), user.getPassword(), user.getLevel().intValue(), user.getLogin(), user.getRecommand(), user.getId()
    );
}
```

- 일반적으로 update 메소드를 테스트하기 위해서는 두 가지 방법을 사용한다.
  - 1. update 메소드가 리턴하는 리턴 값 확인(id를 기준으로 update 했기 때문에 1이 나오는지 확인한다.)
  - 2. update 하려는 데이터 외 변경사항이 존재하는지 확인


### 5.1.3 UserService.upgrdeLevels()

- 유저의 레벨 관리 기능을 구현하기 위해서는 비즈니스 로직을 담고 있는 별도의 UserService가 필요하다.
  - UserDao는 데이터를 어떻게 가져올 것인가에 대한 로직을 담고 있기 때문에 유저의 레벨을 관리하는 기능을 UserDao에 넣는 것은 옳지 않다.
- UserService는 유저 데이터 처리가 필요하기 때문에 `UserDao`를 DI 받아야 한다.
  - 즉, UserService도 Bean으로 등록되어야 한다.
  - 데이터 엑세스 로직의 변경과 UserService의 비즈니스 로직은 관계가 없기 때문에 UserDao는 인터페이스로 선언하는 것이 좋다.

```java
public class UserService {
    UserDao userDao;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }
    ...
}
```

## 5.2 트랜잭션 서비스 추상화

- DB 관련된 로직을 처리할 때 데이터의 트랜잭션 관리가 필요하다.
  - 특정 로직들은 한 번에 처리되어야할 수 있다.
- JDBC API를 이용하여 트랜잭션 관리를 하기 위해서는 별도의 커넥션을 전달해주어야 한다.
  - 이렇게 특정 API를 이용하게 되면, 각 서비스 로직에서 DB마다의 트랜잭션 로직을 넣어주어야 하기 떄문에 비효율적이게 된다.
- 서비스는 하나의 트랜잭션만을 사용하는 것이 아니라, 여러 트랜잭션을 사용해야할 수 있다.
  - 이러한 것을 `글로벌 트랜잭션`이라고 한다.
- 자바에서는 글로벌 트랜잭션을 쉽게 지원하기 위해 `Java Transaction API(JTA)`를 제공한다.
  - 애플리케이션단에서 직접 글로벌 트랜잭션을 구현하는 것이 아니라, 글로벌 트랜잭션을 관리하는 JTA를 통해 쉽게 관리할 수 있다.
- JTA를 사용하더라도, 결국 어떤 DB의 트랜잭션을 사용하느냐에 따라 코드는 계속해서 변경될 수 있다.
- DB에 관계 없이 일관적으로 트랜잭션을 관리할 수 있게 도와주는 것이 `PlatforTransactionManager` 이다.
  - 스프링에서 제공하는 `PlatforTransactionManager` 인터페이스는 트랜잭션 추상화를 제공한다.
  - 각 DB는 각자에 맞게 `PlatforTransactionManager`의 구현체를 가지고 있다.
  - `PlatforTransactionManager`을 사용함에 따라 애플리케이션에서는 각 기술의 트랜잭션 API를 직접 사용하지 않아도 된다.
  - `PlatforTransactionManager`을 어떤 구현체로 사용함에 따라 DB가 변경될 뿐, 실제 사용하는 로직에서는 변경이 일어나지 않는다.
- 비즈니스 로직을 가지고 있는 UserService에서 `PlatforTransactionManager`을 DI 받도록 구현하면,UserService는 DB 변경에 따른 트랜잭션 로직 변화를 신경쓰지 않아도 된다.