# 9장. 스프링 프로젝트로 시작하기

## 9.2 개발 도구와 환경

### 9.2.1 JavaSE와 JavaEE

- 스프링 3.0은 기본적으로 JDK 5.0 또는 그 이상을 필요로 한다.
- 스프링 3.0을 사용하지만, 다른 라이브러리에서 JDK 6.0 이상의 기능이 필요하다면 해당 버전을 사용해야 한다.
- 특별한 상황이 아니라면 버전에 맞게 업그레이드 하자!

### 9.2.2 IDE

- 스프링 개발을 위해서 IDE를 사용하면 좋다.
  - STS, Intellij IDEA 등
- STS 사용 설명(생략)

### 9.2.4 라이브러리 관리와 빌드 툴

#### 라이브러리 관리의 어려움

- 스프링으로 애플리케이션을 만들 때 여러개의 jar 모듈이 필요하다.
  - 스프링이 직접 참조하는 필요 라이브러리는 100개가 넘는다.
- 스프링에서 필요로 하는 라이브러리라고 하더라도 매번 다 쓰이는게 아니기 때문에 적절한 선택이 필요하디.
- 라이브러리는 여러 버전이 존재하기 때문에 각 어느 버전을 사용해야 하는지도 선택해야 한다.

#### 라이브러리 선정

- 스프링에서는 스프링 애플리케이션이 구동되기 위한 기본 틀을 잡아두어 모듈 형태로 만들었다.
- 즉, 사용할 기술 목록을 보고 스프링 모듈을 선택하면 간단하게 개발할 수 있다.
  - 스프링에는 총 20개의 모듈이 존재하고, 필요에 따라 모듈을 선택하면 된다.
- 스프링의 모듈이 필요한 라이브러리 종류와 특징을 보고 선택하면 된다.

#### 빌드 툴과 라이브러리 관리

- Maven과 ANT는 자바의 대표적인 빌드 툴이다.
- Maven은 `POM` 이라는 프로젝트 모델 정보를 이용한다.
- 프로젝트 주요 구조와 특징, 필요한 정보를 POM에 모델 정보로 만들어두면, 이를 참조하여 정해진 절차에 따라 빌드 및 프로젝트 관리를 진행할 수 있다.
- Maven의 특징 중 하나는 애플리케이션이 필요로 하는 의존 라이브러리를 선언해두면, 원격 서버에서 이를 자동으로 다운로드 받아 사용한다는 것이다.
  - Maven은 전이적(transitivie) 라이브러리 추적 기능을 통해 지정된 라이브러리가 동작하는 데 필요한 여타 라이브러리도 자동으로 다운로드해준다.
- Maven을 사용한다 하더라도 결국 실제 ㅈ거용할 라이브러리는 선정해주어야 한다.
- Maven을 통해 프로젝트의 라이브러리 관리를 한다기 보다는 프로젝트 내에서 공통으로 사용하는 모듈과 라이브러리를 간편하게 관리할 수 있게 도와준다고 할 수 있다.

#### 스프링 모듈의 두 가지 이름과 리포지토리

- 스프링 모듈 jar 파일은 두 가지 이름이 존재한다.
  - `spring-core-3.0.7.RELEASE.jar`
  - `org.springframework.core-3.0.7.RELEASE.jar`
  - 두 이름 모두 같은 스프링 모듈을 의미한다.
  - 단지 배포 기술에 따라 관례적으로 사용하는 것이다.
- `spring-core-3.0.7.RELEASE.jar`
  - Maven에서 사용하는 스프링 모듈 jar 파일이다.
  - Maven은 기본적으로 `그룹 아이디`, `아티팩트 아이디`, `버전` 세 가지로 정의하는데, 이떄 라이브러리의 jar 파일은  `아티팩트 아이디` 와 `버전` 일 기준으로 생성된다.
- `org.springframework.core-3.0.7.RELEASE.jar`
  - OSGi 모듈 명명 규칙에 따른 jar 파일이다.
  - Maven을 통해 OSGi 호환 이름을 사용하기 위해서는 Maven 표준 리포지토리 대신 스프링소스가 제공하는 엔터프라이즈 번들 리포지토리를 사용해야 한다.
  - 별도의 리포지토리에서 org.springframework.core-3.0.7.RELEASE.jar 이름에 맞는 `그룹 아이디`, `아티팩트 아이디`, `버전` 을 통해 라이브러리를 받을 수 있다.
- 즉, 같은 파일이 별도의 리포지토리에 다른 이름으로 존재하는 것이다.

## 9.3 애플리케이션 아키텍처

### 9.3.1 계층형 아키텍처

- 성격이 다른 모듈이 강하게 결합되어 있으면, 변화에 따라 불필요한 부분까지도 변경이 일어나며 오류가 발생할 수 있다.
- 모듈 뿐 아니라 아키텍처 레벨에서도 비슷한 책임과 성격을 가진 것들을 묶고 느슨한 결합을 만들어야 한다.
- 이렇게 책임과 성격이 다른 것을 그룹으로 묶는 것을 `계층형 아키텍처(layered architecture)` 혹은 `멀티 티어 아키텍처`라고 한다.
- 일반적은 웹 기반의 애플리케이션은 세 개의 게층을 갖는다.

#### 3계층 아키텍처와 수직 계층

- 웹 애플리케이션의 3계층은 `프레젠테이션`, `서비스`, `데이터 엑세스` 계층으로 나뉜다.
  - 이 3계층은 모두 수평적으로 구분된다.
- 데이터 액세스 계층
  - 데이터 액세스 계층은 간단하게 DAO 계층이라고 불리며 DB 외에도 ERP, 레거시 시스템 등에 접근하는 역할을 한다.
  - 데이터 액세스 계층 안에서도 사용 기술에 따라 세분화되어 계층이 나뉜다.
    - 이렇게 세분화되는 계층을 `수직적 계층` 이라고 한다.
    - 수직적 계층은 추상화 수준에 따라 구분된다.
- 서비스 계층
  - 서비스 계층은 POJO로 작성되며, 객체지향적인 설계 기법이 적용된 코드로 작성한다.
  - 서비스 계층에서 DAO 계층을 호출하고 이를 활용해서 만들어진다.
  - DAO 계층 외에 다른 서버나 시스템 레벨에 제공하는 기반 서비스를 활용할 수 있다.
  - 서비스 계층은 특별한 경우가 아니라면 추상화 수직 계층구조를 가질 필요가 없다.
  - 원칙적으로 서비스 계층 코드는 기반 서비스 계층의 구현에 종속되면 안 된다.
    - 서비스 계층의 코드는 추상화된 기반 서비스 인터페이스를 통해서만 접근하도록 만들어야 한다.
  - 이상적인 서비스 계층은 DAO 계층이 바뀌고, 프레젠테이션 계층이 바뀌어도 유지되어야 한다.
- 프레젠테이션 계층
  - 프레젠테이션 계층은 가장 복잡한 계층이다.
  - 프레젠테이션 계층은 클라이언트 종류와 상관없이 HTTP 프로토콜을 사용하는 서블릿이 바탕이 된다.
  - 프레젠테이션 계층은 다른 계층과 달리 클라이언트까지 그 범위를 확장될 수도 있다.

#### 계층형 아키텍처 설계의 원칙

- 각 계층은 아키텍처 레벨이나 계층과 상관 없이 객체지향 설계 원칙을 적용해야 한다.
- 각 계층은 자신의 계층의 책임에만 충실해야 한다.
  - 자신의 역할과 기술에만 충실하게 만들면, 각 계층 사이의 결합도는 자연스럽게 낮아진다.

### 9.3.2 애플리케이션 정보 아키텍처

- 기존의 엔터프라이즈에서는 데이터 중심의 아키텍처 구조가 많았다.
- 데이터 중심 아키텍처라는 것은, 실제 비즈니스 로직이 SQL에 모두 담겨 있고 프레젠테이션과 서비스 계층에서 DAO 계층을 단순 조회하는 아키텍처이다.
- 이러한 아키텍처는 SQL에 굉장히 의존적이게 되고, 수정이 발생했을 때 검증이나 변화가 너무 많아진다.
- 데이터 중심 아키텍처 보다는 DAO 는 데이터 조회 역할만 하고, 서비스 계층에서 주요 로직을 처리하는 것이 더 좋다.
  - 이를 `거대한 서비스 계층(fat service layer)`이라고 한다.
- 서비스 계층에서 비즈니스 로직을 모두 담고 있기 때문에 애플리케이션 코드의 비중은 커지지만, 구조는 단순해지고 객치지향 개발의 장점을 살릴 수 있게 된다.
- 서비스 계층의 비중은 커지지만, POJO로 작성되어 있기 떄문에 테스트도 간단해지고 변화도 쉽다.

### 9.3.3 오브젝트 중심 아키텍처

- 오브젝트 중심 아키텍처는 도메인 모델을 반영하는 오브젝트 구조를 만들어서 각 계층 사이에 정보를 전송한다.

#### 데이터와 오브젝트

- 데이터를 중심으로 설계하게 되면 모든 계층에서는 SQL을 통해 어떤 데이터를 어떻게 가져왔는지 모두 알고 있어야 한다.
  - 즉, 모든 계층에서 DAO 계층에 의존적이게 된다.
- 오브젝트 방식에서는 애플리케이션에서 사용되는 정보가 도메인 모델의 구조를 반영해서 오브젝트 안에 담기게 된다.
  - 즉, 도메인 모델은 애플리케이션 전 계층에서 동일한 의미를 가지게 된다.
  - SQL등에 종속적이지 않고 일관된 형식의 애플리케이션의 정보를 다룰 수 있게 된다.
- 도메인 모델을 반영하는 오브젝트는 자바 언어의 특성을 최대한 활용할 수 있다.
- 오브젝트 방식을 통해 각 계층은 장점이 생긴다.
  - DAO는 단순히 데이터를 가져와 도메인 오브젝트로 변환만 해주면 되고 어떠한 트랜잭션에서 사용될 지 신경쓰지 않아도 된다.
  - 서비스 계층에서는 DAO가 어떤 SQL을 통해 어떻게 데이터를 가져오는지 관심이 없고, 단순히 도메인 오브젝트만으로 비즈니스 로직을 처리하면 된다.

#### 도메인 오브젝트를 사용하는 코드

- 도메인 오브젝트를 사용함에 따라 재사용 가능한 코드를 손쉽게 작성할 수 있다.
- 데이터 중심 방식에서는 SQL이 어떤 데이터를 가져오는지 모두 다르기 때문에 재사용 코드 작성이 어렵다.

#### 도메인 오브젝트 사용의 문제점

- 도메인 오브젝트를 사용하면, 코드 이해가 쉽기 때문에 로직 작성이 수월해지며 DAO가 작성되지 않아도 미리 코드를 작성할 수 있다.
- 하지만, 단점도 존재한다.
- 기본적으로 로직에 최적화된 SQL을 매번 만들 수 없기 때문에 성능상 문제가 존재한다.
  - DAO는 비즈니스 로직에서 어떻게 사용할 지 모르기 때문에 모든 값을 다 채워야 한다.
  - 채우지 않는 경우, 사용하는 입장에서 NPE를 막기 위한 로직이 매번 들어가야 한다는 단점이 있다.
- 이러한 문제를 해결하기 위해 별도의 오브젝트를 사용하기도 하고, 지연 로딩 등의 기술을 사용하기도 한다.
  - 모든 오브젝트나 메소드를 별도로 만들기 보다는 ORM 기술을 사용하는 것이 가장 이상적이다.
  - 도메인 오브젝트를 사용하는 경우 가능하다면 ORM 기술을 사용하는 것을 권장한다.

#### 빈약한 도메인 오브젝트 방식

- 도메인 오브젝트에 정보만 담겨 있고 아무런 기능이 없다면 온전한 오브젝트라 보기 어렵다.
  - 이런 오브젝트를 빈약한(anemic) 오브젝트라 한다.
- 빈약한 오브젝트라 하더라도 도메인 모델을 사용하지 않는 것 보다는 훨씬 낫고, 이러한 방식도 많이 쓰인다.
- 빈약한 도메인 오브젝트는 단순히 데이터만 가지고 있고 실제 해당 로직은 서비스 계층이나 프레젠테이션 계층이 가지고 있다.
  - 이러한 방식은 거대 서비스 계층 방식과 비슷하다.
- 모든 계층이 DAO에 의존하는 것 처럼 빈약한 도메인 오브젝트에 의존하게 된다.
  - 그렇기 때문에 한계점도 동일하다.
  - 빈약한 도메인 오브젝트에 의존하여 재사용성이 떨어지고 중복 문제가 발생하기 쉽다.
  - SQL에 대한 의존성이 도메인 오브젝트로 이동한 것이다.

#### 풍성한 도메인 오브젝트 방식

- 빈약한 도메인 오브젝트 방식의 단점을 극복한 것이 풍성한 도메인 오브젝트(rich domain obejct) 또는 영리한 도메인 오브젝트(smart domain object) 라고 한다.
- 도메인 오브젝트가 가지고 있는 비즈니스 로직은 도메인 오브젝트에 넣어주고, 서비스 계층에서는 비즈니스르 로직을 사용하기만 하는 것이다.
- 도메인 오브젝트 안에 로직을 담아주면, 이 로직을 서비스 계층의 메소드에 따로 만드는 것 보다 응집도가 높아진다.
  - 해당 로직은 도메인 오브젝트의 데이터로 처리되지만, 서비스 있을 경우 해당 로직을 사용하는 다른 서비스에서는 DI를 해야 하는 번거로움이 있게 된다.
- 풍성한 도메인 오브젝트 방식은 도메인 오브젝트를 사용한다는 면에서는 비슷하지만, 훨씬 간결하고 객체지향적이다.
- 도메인 오브젝트 안에 메소드로 들어가는 로직들은 대부분 해당 오브젝트와 긴밀한 기능만을 활용한다.

#### 도메인 계층 방식

- 도메인 오브젝트는 기본적으로 Bean으로 등록되어 있지 않기 때문에 스프링에서 DI를 해줄 수 없다.
  - 즉, 서비스 계층이나 DAO 계층의 로직을 사용할 수 없다.
- 도메인 오브젝트가 스스로 필요한 정보를 DAO를 통해 가져오거나 변경사항 반영등을 하기 위해서 등장한게 `도메인 계층 방식`이다.
- 도메인 계층 방식은 도메인 오브젝트들이 하나의 독립적인 계층을 이뤄서 서비스 계층과 DAO 계층 사이에 존재하게 된다.
- 도메인 계층은 기존 방식과 다른 두 가지 특징이 있다.
  - 1. 도메인에 종속적인 비즈니스 로직의 처리는 서비스 계층이 아니라 도메인 계층 오브젝트 안에서 진행된다.
  - 2. 도메인 오브젝트가 기존 DAO 계층이나 기반 계층의 기능을 직접 활용할 수 있다.
    - 도메인 오브젝트는 Bean이 아니라 스프링이 DI를 할 수 없기 때문에 별도의 설정을 추가해야 한다.
- 도메인 계층 방식을 사용하기 위해서는 AOP가 필요하다.
  - Bean으로 등록되지 않았기 때문에 스프링 AOP가 아니라 AspectJ AOP를 사용해야 한다.
  - 이를 통해 도메인 오브젝트 생성 시점에 DI 가 가능해진다.
- 도메인 계층에서 모든 비즈니스 로직을 담당한다 하더라도, 서비스 계층은 필요하다.
  - 서비스 계층에서는 여러 도메인 오브젝트의 기능을 조합해야 하는 경우 사용한다.
  - DAO 계층에서 정보를 가져와 클라이언트에 제공할 떄 서비스 계층이 인터페이스 역할을 해야 한다.
  - 트랜잭션 경계 설정이나 기반 서비스 이용시에도 서비스 계층이 필요하다.
- 도메인 오브젝트를 독립적인 계층으로 만들기 위해서 가장 중요한 것은 도메인 오브젝트가 도메인 계층을 벗어나서도 사용되게 할지 말지를 결정해야 한다.
  - 1. 모든 계층에서 도메인 오브젝트를 사용한다.
    - 가장 간단한 방법이지만 심각한 혼란을 초래할 수 있다.
    - 도메인 오브젝트가 비즈니스 로직이나 DB 조작 등의 기능을 담고 있다 보니 프레젠테이션 계층에서 사용하면 위험이 따를 수 있다.
    - 이 방법을 사용할 경우 철저한 개발 가이드라인을 만들어두고 강력하게 적용해야 한다.
  - 2.도메인 오브젝트는 도메인 계층을 벗어나지 못하게 한다.
    - 도메인 계층 밖으로 전달할 때에는 별도로 준비된 전달용 오브젝트를 반환한다.
    - 이런 오브젝트는 데이터 전달용으로만 사용되며 DTO(Data Transfer Object) 라고 한다.
    - DTO는 상태의 변화를 허용하지 않고 읽기용으로만 만들어지기도 한다.
- 이렇게 도메인 계층은 설정이 어렵고 불편하지만 매우 복잡하고 변경이 잦은 도메인을 가졌을 때 사용하면 좋다.
  - 도메인 모델과 설계에 변경이 발생했을 때 도메인 계층의 오브젝트도 빠르게 대응할 수 있다.

### 9.3.4 스프링 애플리케이션을 위한 아키텍처 설계

#### 계층형 아키텍처

- 3계층 구조는 논리적이고 개념적인 구분이지 꼭 오브젝트 단위로 딱 끊어서 만들어지는게 아님을 염두에 둬야 한다.
  - 프레젠테이션 계층과 서비스 계층을 합칠 수도 있고, 서비스 계층과 DAO 계층을 합칠 수도 있다.