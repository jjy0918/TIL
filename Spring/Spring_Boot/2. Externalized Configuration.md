# 2. Externalized Configuration

- Spring Boot에서는 configuration 설정을 외부화하여 서로 다른 환경에서 사용할 수 있다.
  - Java properties 파일, YAML 파일, 환경 변수 등
- properties 값은 `@Value` 어노테이션을 통해 bean에 주입할 수 있고, `@ConfigurationProperties`를 통해 구조화된 객체에 바인딩할 수 있다.
- Spring Boot는 PropertySource 순서가 존재하며, 순서대로 고려된다.

1. Default Properties(SpringApplication.setDefaultProperties에 설정된 값.)
2. `@Configuration` 클래스의 `@PropertySource` 어노테이션
3. `appication.properties`의 데이터
4. `random.*.`의 `RandomValuePropertySource `
5. OS의 환경 변수
6. Java의 시스템 Properties
7. JNDI attribute
8. ServletContet의 parameters
9. ServletConfig의 parameters
10. `SPRING_APPLICATION_JSON `의 Properties
11. Command line의 arguments
12. `@SpringBootTest` 의 properties
13. test에서의 `@TestPropertySource`

- Config 데이터의 고려 순서

  1.  jar안에 패키징 된 Application Properties.
  2.  jar안에 패키징 된 프로파일 별 properties.
  3.  jar 밖 Application Properties
  4.  jar 밖 프로파일 별 properties

- config에 대한 properties 구성 시 `.properties` or `.yml` 파일 사용하는 경우 둘 중 하나의 형식을 사용하는 것이 좋다.
  - 같은 위치에 있는 경우 `.properties`가 우선적으로 적용된다.

```java
@Component
public class MyBean {

    @Value("${name}")
    private String name;

    // ...

}
```

## 2.1 Accessing Command Line Properties

- 기본적으로 `SpringApplication`은 `command line`으로 properties argument를 받을 수 있다.
- command line으로 받은 properties는 file 기반보다 우선으로 적용된다.
- command line으로 argument를 받고 싶지 않은 경우 `SpringApplication.setAddCommandLinePropertise(false)`를 설정하면 된다.
- command line은 `--` 키워드 와 함께 사용하면 된다.(예시: `--server.port=9000`)

## 2.2 Json Application Properties

- Spring Boot에서는 JSON 구조의 데이터도 인코딩하여 사용할 수 있다.
- Application이 시작되면, spring.application.json이나 SPRING_APPLICATION_JSON properties의 데이터를 분석하고 설정에 추가된다.
- null 값이 있는 JSON의 경우 property source에 추가될 수 있다. 다만, null의 하위 속성은 재정의가 불가능하다.

```shell
// SPRING_APPLICATION_JSON 이용
$ SPRING_APPLICATION_JSON='{"my":{"name":"test"}}' java -jar myapp.jar

// spring.application.json
$ java -Dspring.application.json='{"my":{"name":"test"}}' -jar myapp.jar

$ java -jar myapp.jar --spring.application.json='{"my":{"name":"test"}}'
```

## 2.3 External Application Properties

- Spring Boot는 실행될 때 application.properties와 application.yaml 파일을 찾는 위치는 순서가 존재한다.
  - 1. classpath
    - 1. classpath의 root
    - 2. classpath의 `/config` 패키지
  - 2. 현재 디렉토리
    - 1. 현재 디렉토리
    - 2. 현재 디렉토리의 `/config` 하위 디렉토리
    - 3. `/config` 디렉토리의 하위 디렉토리
- 위 순서에 의해서 파일을 찾아 적용한다.
- config파일의 이름을 `application`으로 하기 싫다면, `spring.config.name`에서 파일 이름을 지정할 수 있다.
  - `$ java -jar myproject.jar --spring.config.name=myproject`
  - 설정 파일을 application.properties, application.yaml이 아니라 myproject.properties, myproject.yaml 파일을 찾는다.
- `spring.config.location` 설정을 통해 파일의 지정 위치도 변경할 수 있다.

```shell
$ java -jar myproject.jar --spring.config.location=\
    optional:classpath:/default.properties,\
    optional:classpath:/override.properties
```

- `spring.config.location`의 경우 디렉토리가 포함되어 있으면 `/`로 끝나야 한다.
- 디렉토리나 file location 값도 프로파일에 대해 확장이 가능하다.
- `spring.config.location`으로 위치를 설정하는 경우, 해당 위치가 기본 값이 된다.
  - `optional:classpath:/custom-config/,optional:file:./custom-config/`로 설정하는 경우
  - => `optional:classpath:custom-config/`
  - => `optional:file:./custom-config/`
- `spring.config.additional-location`으로 위치를 설정하는 경우, 기본 값에 해당 위치가 포함된다.
  - `optional:classpath:/custom-config/,optional:file:./custom-config/`로 설정하는 경우
  - => `optional:classpath:/;optional:classpath:/config/`
  - => `optional:file:./;optional:file:./config/;optional:file:./config/*/`
  - => `optional:classpath:custom-config/`
  - => `optional:file:./custom-config/`
- 위 설정들을 통해 기본값 지정과 선택적으로 하여 다른 파일로 런타임 재정의가 가능해진다.

### 2.3.1 Option Locations

- 기본적으로 지정된 위치에 config 파일이 존재하지 않으면 `ConfigDataLocationNotFoundException`가 발생하고 application이 시작되지 않는다.
- 구체적인 위치를 지정했지만, 파일이 반드시 존재하는 경우가 아닌 경우 `optioanl:` prefix를 이용하면 된다.
  - `spring.config.location`, `spring.config.additional-location`, `spring.config.import`에서 사용할 수 있다.
  - 예를 들어, `spring.config.import`값이 `optional:file:./myconfig.properties` 이면, myconfig.properties 파일이 없어도 된다.
- `ConfigDataLocationNotFoundExceptions`를 무시하고 application을 실행하고 싶다면 `spring.config.on-not-found` 값을 `ignore`로 전달하거나 `SpringApplication.setDefaultProperties(…​)`를 이용하면 된다.

### 2.3.2 Wildcard Locations

- config 파일의 경로 마지막에 `*`이 포함된 경우 와일드 카드 위치로 간주된다.
- 와일드 카드 경로의 경우 하위 디렉토리도 모두 검사한다.
- 예를 들어, redis와 MySQL config 파일이 존재하는 경우
  - `/config/*/` 로 설정하면 된다.
  - => `/config/redis/application.properties` 확인
  - => `/config/mysql/application.properties` 확인
- 기본적으로 Spring Boot에서는 `config/*/`가 포함된다.
- `spring.config.location`, `spring.config.additional-location` 에서 와일드 카드를 사용할 수 있다.
- 디렉토리의 경우 `*`가 하나만 포함해야 하고, `*/`로 끝나야 한다.
- 파일의 경우 `*/{fileName}`이어야 한다.
- 와일드 카드가 있는 위치는 파일 이름의 절대 경로를 기준으로 알파벳 순으로 정렬된다.
- 와일드 카드 위치는 `외부 디렉토리`에서만 동작한다.
  - `classpath:location` 에서는 동작하지 않는다.

### 2.3.3. Profile Specific Files

- application 기존 properties 뿐만 아니라 profile별 `applciation-{profile}`의 파일도 로드한다.
- 예를 들어, prod라는 profile을 활성화 하면 `apllciation.yaml`과 `application-prof.yaml` 모두 로드한다.
- profile별 application은 기본 위치를 같이 사용하며, 기본 application을 덮어쓴다.
- 여러 profile이 있는 경우, 마지막 profile로 덮어쓴다.
- active profile이 설정되어 있지 않은 경우 `application-default`가 고려된다.

### 2.3.4 Importing Additional Data

- `spring.config.import` 옵션을 이용하여 다른 위치의 데이터를 가져올 수 있다.

```yaml
spring:
  application:
    name: "myapp"
  config:
    import: "optional:file:./dev.properties"
```

- `spring.config.import`를 통해 가져온 파일은 그 이전 파일의 값을 덮어쓴다.
  - 예를 들어, default.yaml 파일을 통해 dev.properties를 가져오고 중복 값이 존재하면 dev.properties 값이 적용된다.
- `spring.config.import`를 통해 같은 파일을 여러 번 가져와도 적용되는 것은 한 번이다.
- 하나의 `spring.config.import` 설정에 여러 파일을 나열할 수 있고, 나열된 순서대로 가져오게 된다.
- profile이 설정된 경우 profile에 대한 값도 고려하게 된다.
  - `my.properties` 를 import하면 my.properties와 `my-<profile>.properties`도 고려된다.
- `org.springframework.boot.context.config`의 `ConfigDataLoader`와 `ConfigDataLoader`를 이용하면 다양한 위치에 대해 새롭게 정의할 수 있다.

### 2.3.5 Importing Extensionless Files

- Spring Boot는 확장자가 없는 파일을 가져올 수 있도록 지원한다.
- 예를 들어, /etc/config/myconfig을 가져와야 하는 경우

```yml
spring:
  config:
    import: "file:/etc/config/myconfig[.yaml]"
```

### 2.3.6. Using Configuration Trees

- 쿠버네티스 등 클라우드 시스템에서는 파일 안에 비밀번호 등의 데이터가 있다.
- Spring Boot에서는 해당 파일 이름을 키로, 내용을 값 형태로 저장할 수 있는 기능을 제공한다.

```
etc/
  config/
    myapp/
      username
      password
```

- 쿠버네티스의 volume이 위 처럼 구성되어 있고 username이라는 파일에 값이 들어 있고, password라는 파일에 값에 들어 있다면

```yml
spring:
  config:
    import: "optional:configtree:/etc/config/"
```

- 위 설정을 통해 `myapp.username`과 `myapp.password` properties가 등록된다.
  - username이라는 파일에 "foo" 라는 값이 들어 있다면 myapp.username은 foo가 된다.
- value 값은 `String`과 `byte[]` 모두 가능하다.
- configtree 값에 `*`을 이용하여 여러 값을 가져올 수 있다.

```
etc/
  config/
    dbconfig/
      db/
        username
        password
    mqconfig/
      mq/
        username
        password
```

```yml
spring:
  config:
    import: "optional:configtree:/etc/config/*/"
```

- `db.username`, `db.password`, `mq.username`, `mq.password` 를 사용할 수 있다.

### 2.3.7. Property Placeholders

- 이전에 정의된 값을 다시 사용할 수 있다.
- ## 사용할 때에는 `소문자를 사용하는 kebab-case`를 사용해야 한다.

```yml
app:
  name: "MyApp"
  description: "${app.name} is a Spring Boot application written by ${username:Unknown}"
```

### 2.3.8. Working with Multi-Document Files

- 여러 값을 물리적 파일로 나눌수도 있지만, 하나의 파일안에 모두 넣을 수 있다.
- `---`(yaml), `#---`(properties) 을 이용하면 독립적으로 구분이 된다.
- 각 구분 기호 앞에는 공백이 없어야 하며, 앞뒤로는 주석이어서는 안된다.
- `@PropertySource`와 `@TestPropertySource`을 사용하는 경우 Multi-Document file의 제약이 있다.

```yml
spring:
  application:
    name: "MyApp"
---
spring:
  application:
    name: "MyCloudApp"
  config:
    activate:
      on-cloud-platform: "kubernetes"
```

### 2.3.9. Activation Properties

- `spring.config.activate`를 사용하여 특정 조건에 따라 profile을 활성화 할 수 있다.
- `on-profile`은 프로파일 활성화 조건이 성립되는 경우 적용할 프로파일 정보를 담는다.
- `on-cloud-platform`은 어떠한 `CloudPlatform`이 실행되는지에 대한 정보를 담는다.

```yml
myprop: "always-set"
---
spring:
  config:
    activate:
      on-cloud-platform: "kubernetes"
      on-profile: "prod | staging"
myotherprop: "sometimes-set"
```

- 쿠버네티스가 활성화 되면 prod, staging 중 하나가 active 된다.
