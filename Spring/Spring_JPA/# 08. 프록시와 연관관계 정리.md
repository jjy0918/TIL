# 08. 프록시와 연관관계 정리

## 8.1 프록시

- JPA에서 엔티티는 연관관계의 엔티티들을 항상 사용하는 것이 아니다.
- 그러다 보니 불필요하게 조회될 수 있는 문제가 발생하고 이러한 것들을 해결하기 위해 `지연 로딩`에 대한 기능을 제공한다.
- 지연 로딩을 위해 가짜 엔티티 객체를 제공하고, 이를 프록시 객체라고 한다.
- JPA는 지연 로딩의 구현 방법을 각 구현체에 위임했다.(하이버네이트 기준으로 설정)

### 8.1.1 프록시 기초

- 프록시 객체를 통해 조회하고 싶다면 `em.getReferance` 메소드를 이용하면 된다.
- 프록시 객체는 실제 사용 전까지 데이터 베이스에 엔티티를 요청하지 않는다.
- 프록시 객체를 사용하는 시점에 데이터 베이스에 요청하여 실제 엔티티를 가져와 사용한다.
- 프록시 객체는 초기화되어도 실제 엔티티로 바뀌는 것이 아니기 때문에 타입 체크에 주의해야 한다.
- 영속성 컨텍스트에 찾는 엔티티가 있다면, 프록시가 아닌 실제 엔티티를 반환한다.

### 8.1.2 프록시와 식별자

- 프록시 객체를 가져온 후 식별자 프로퍼티를 조회해도 프록시 초기화는 일어나지 않는다.

### 8.1.3 프록시 확인

- JPA가 제공하는 `PersistneceUnitUtil.isLoaded(Object entity)` 메소드를 사용하면 프록시 인스턴스 초기화 여부를 알 수 있다.
  - 아직 초기화가 되지 않았다면 `false`를 반환한다.
  - 초기화되었거나 프록시 인스턴스가 아니라면 `true`를 반환한다.

## 8.2 즉시 로딩과 지연 로딩

- JPA는 개발자가 연관된 엔티티의 조회 시점을 선택할 수 있는 방법을 제공한다.

### 8.2.1 즉시 로딩

- `즉시 로딩(EAGER LOADING)`은 엔티티 조회시 연관 엔티티도 같이 조회하는 것이다.
- `fetch` 속성을 `FetchType.EAGER`로 설정하면 된다.
- JPA는 `즉시 로딩`을 `최적화`하기 위해 가능하면 `조인 쿼리`를 사용한다.
- JPA는 기본적으로 조인 시 nullable을 고려하기 위해 외부 조인(outer join)을 사용한다.
- 내부 조인을 사용하기 위해서는 JoinColumn의 nullable 값을 false로 병시해주어야 한다.

### 8.2.2 지연 로딩

- `지연 로딩(LAZY LOADING)`은 엔티티 조회 후 실제 사용 시 엔티티를 조회하는 것이다.
- `fetch` 속성을 `FetchType.LAZY`로 지정하면 된다.
- 지연 로딩 시 연관 객체는 프록시 객체가 할당된다.

### JPA 기본 패치 전략

- `@ManyToOne`, `@OneToOne`: 즉시 로딩
- `@OneToMany`, `@ManyToMany`: 지연 로딩

- 기본적으로 모든 연관관계에 지연 로딩을 사용하다가 꼭 필요한 부분만 즉시 로딩을 사용하는 것이 좋다.
- 컬렉션 한 이상 즉시 로딩하는 것은 권장하지 않는다.
- 컬렉션 즉시 로딩은 항상 외부 조인을 사용한다.

## 8.4 영속성 전이:CASCADE

- JPA에서 엔티티 저장 시 연관된 모든 엔티티는 영속 상태여야 한다.
- 영속성 전이를 사용하면 부모만 영속 상태로 만들어도 연관된 자식들 모두 영속 상태가 된다.

## 8.5 고아 객체

- JPA는 부모 엔티티와 연관관계가 끊어진 자식 엔티티를 자동으로 삭제하는 `고아 객체(ORPHAN) 제거` 기능을 제공한다.
- 부모 엔티티의 컬렉션에서 자식 엔티티의 참조만 제거하면, 자식 엔티티가 자동으로 삭제된다. 