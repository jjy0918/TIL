# 11. 클라이언트 식별과 쿠키

## 11.1 HTTP 헤더

- From: 사용자의 이메일 주소 포함
- User-Agent: 사용자의 브라우저
- Refere: 사용자가 현재 링크를 타고 온 근원 페이지
- Authorization: 사용자 이름과 비밀번호
- Client-ip: 클라이언트의 IP 주소
- X-Forwared-For: 클라이언트의 IP주소
- Cookie: 서버가 생성한 ID 라벨

## 11.2 클라이언트 IP 주소

- 웹에서는 클라이언트의 IP 주소를 얻기 위한 욕구가 존재한다.
- HTTP는 TCP를 사용하기 때문에(2.0 이하) TCP 커넥션의 IP 주소는 얻을 수 있다.
  - ex) 유닉스의 getpeername 함수
  - 다만, 이러한 방식으로는 정확한 IP 주소를 알지는 못한다(프락시, ISP 등).
  - 정확한 주소를 알기 위해 Client-ip나 X-Forwared-For 같은 확장 헤더를 사용한다.
- Client-ip 헤더를 통해 클라이언트 IP 주소를 알 수 있지만, 이 헤더는 표준이 아니기 때문에 반드시 알 수 있는 것이 아니다.

## 11.3 사용자 로그인

- 사용자를 식별하기 위해 IP 주소는 사용하기 어렵다.
- 그래서 일반적으로는 사용자 이름과 비밀번호를 통해 사용자를 식별하고 인증을 한다.
- HTTP에서는 `Authorization`과 `WWW-Authenticate` 헤더를 통해 웹 사이트 자체적인 체계를 가질 수 있다.
  - 로그인이 완료된 사용자는 위 헤더에 인증 정보를 가지고 있기 때문에 로그인 정보를 확인할 수 있다.
- 사용자가 인증이 필요하다면, 401 상태 코드와 함께 인증 페이지로 리다이렉션 등의 행위를 통해 인증을 요구할 수 있다.
- 인증이 완료된(로그인 된) 사용자는 `Authorization` 헤더에 인증 토큰을 담고, 해당 토큰을 이용하여 사용자를 식별한다.

## 11.4 뚱뚱한 URL

- 사용자의 정보를 담고 있는 URL을 뚱뚱한 URL이라고 한다.
- 웹 서버와 통신하는 독립적인 HTTP 트랜잭션을 하나의 세션 혹은 방문으로 묶는 용도로 뚱뚱한 URL을 사용할 수 있다.
  - 즉, 뚱뚱한 URL을 이용하여 사용자를 식별하는데 사용할 수 있다는 것이다.
- 뚱뚱한 URL에는 여러 문제가 발생할 수 있다.
  - 뚱뚱한 URL은 흔히 못생긴 URL이라고도 불리며, 새로운 사용자들에게 혼란을 줄 수 있다.
  - 뚱뚱한 URL은 사용자의 정보를 담고있기 때문에 공유를 할 경우, 개인 정보가 공유되기 때문에 공유할 수 없게 된다.
  - 뚱뚱한 URL은 인증 정보나 사용자 식별 하는 등 자주 달라지기 때문에 기존 캐시에 접근하기 힘들다.
  - 뚱뚱한 URL에 해당하는 HTML 페이지를 다시 그려야 하기 때문에 서버에 부하가 될 수 있다.
  - 사용자에 대한 정보는 URL에 담겨있기 때문에 사용자가 이탈하는 경우 지금까지 진척된 사항들을 잃어버리기 쉽다.

## 11.5 쿠키

- 쿠키는 사용자를 식별하고 세션을 유지하는 방식 중 가장 많이 사용되는 방식이다.

### 11.5.1 쿠키의 타입

- 쿠키는 기본적으로 `세션 쿠키(session cookie)`와 `지속 쿠키(persistent cookie)` 로 나뉜다.
- 세션 쿠키는 사용자가 웹 사이트 탐색 시 관련한 설정과 선호 사항들을 저장하는 임시 쿠키이다.
  - 기본적으로 세션 쿠키는 사용자가 웹 브라우저를 닫을 때 삭제된다.
- 지속 쿠키는 세션 쿠키보다 더 길게 유지될 수 있다.
  - 브라우저를 닫는 행동과 관계 없다.
  - 일반적으로 웹 사이트의 설정 정보나 로그인 이름 등을 유지하기 위해 사용된다.
- 세션 쿠키와 지속 쿠키의 가장 큰 차이점은 파기 시점이다.
  - 세션 쿠키는 웹 브라우저가 닫히면 삭제된다.
  - 지속 쿠키는 Discard 파리미터나, Expires, Max-Age 파리미터를 통해 파기 시점이 결정된다.
  - 위 파리미터가 없다면, 세션 쿠키가 된다.

### 11.5.2 쿠키는 어떻게 동작하는가?

- 기본적으로 쿠키는 이름=값 형태의 정보를 리스트 형태로 가지고 있다.
  - 쿠키 리스트는 Set-Cookie 혹은 Set-Cookie2(확장 헤더) 형태로 HTTP 헤더에 기술된다.
- 웹 서버는 사용자를 구분하기 위해 유일한 쿠키 값을 할당한다.
- 브라우저는 기본적으로 서버로부터 Set-Cookie 설정된 값을 브라우저 쿠키 데이터베이스에 저장한다.
  - 사용자가 나중에 같은 웹 사이트를 방문한다면, 브라우저에 저장된 쿠키 값을 가져와 전달한다.

### 11.5.3 쿠키 상자: 클라이언트 측 상태

- 브라우저는 쿠키 정보를 저장할 책임이 있고, 이러한 시스템을 `클라이언트 측 상태`라고 한다.
  - 쿠키 명세에서 공식적인 이름은 `HTTP 상태 괸리 체계(HTTP Status Management Mechanism)`이라고 한다.
- 구글 크롬 쿠키
  - 구글 크롬의 경우 Cookies라는 SQLite 파일에 쿠키를 저장한다.
  - create_utc는 쿠키 생성 시점을 의미한다.
  - host_key는 쿠키의 도메인을 의미한다.
  - name은 쿠키의 이름을 의미한다.
  - value는 쿠키의 값을 의미한다.
  - path는 쿠키와 관련된 도메인에 있는 경로를 의미한다.
  - expire_utc는 쿠키 파기 시점을 의미한다.
  - secure는 SSL 커넥션인 경우 보낼지를 의미한다.
- 인터넷 익스플로러 쿠키
  - 인터넷 익스플로러는 캐시 디렉터리에 각각의 개별 파일로 쿠키를 저장한다.

### 11.5.4 사이트마다 각기 다른 쿠키들

- 브라우저는 가지고 있는 쿠키를 모든 사이트에 보내지는 않는다.
- 해당 서버에서 생성된 쿠키만 보낸다.
- 광고사에서 웹 사이트와 연계하여 광고 정보를 웹 사이트 자체인 것 처럼 지속 쿠키를 만들 수 있다.
  - 이러한 행위를 통해, 다양한 웹 사이트를 방문해도 광고사 서버로 데이터가 전송될 수 있다.
  - 이렇게 다양한 데이터를 구축하기도 한다ㅣ.
- 쿠키의 `Domain` 속성을 통해 어떤 사이트가 쿠키를 읽을 수 있는지 제어할 수 있다.
- 쿠키의 `Path` 속성을 통해 웹 사이트 일부에만 쿠키를 적용할 수 있다.

```http
Set-Cookie: pref=compact; domain="airtravelbargains.com"; path=/autos/
```

### 11.5.5 쿠키 구성 요소

- 이름=값
  - 필수 속성
  - `이름`과 `값` 모두 큰 따옴표로 감싸지 않은 세미콜론, 쉼표, 등호, 공백을 포함하지 않은 문자열로 구성된다.
- Expires
  - 선택 속성
  - 쿠키의 생명주기를 가리키는 날짜 문자열을 기술한다.
  - 사용할 수 잇는 타임 존은 GMT뿐이다.
  - 날짜 요소 간 구분자는 `-`이어야 한다.
  - 쿠키에 Expires 속성을 명시하지 않으면, 세션이 끝날 때 파기된다.
  - `요일, DD-MM-YY HH:MM:SS GMT` 형태로 구성된다.
- Domain
  - 선택 속성
  - 명시하지 않을 경우 서버의 호스트 명을 기본적으로 사용한다.
  - 기본적으로 두 개에서 세 개 영역을 가지는 도메인을 기술해야 한다.
- Path
  - 선택 속성
  - 서버에 있는 특정 문서에만 쿠키를 전달할 수 있다.
  - URL의 앞 부분과 Path가 일치하는 경우 쿠키를 전달한다.
  - 명시하지 않을 경우 Set-Cookie 응답을 전달하는 URL의 경로가 사용된다.
- Secure
  - 선택 속성
  - 이 속성이 포함되어 있다면, 쿠키는 HTTP SSL을 사용할 때에만 전달된다.
