# 스트리밍 프로토콜(HLS, DASH)

> https://ottverse.com/hls-vs-mpeg-dash-video-streaming/
> 
> https://ottverse.com/what-is-abr-video-streaming/

## HLS(HTTP Live Streaming)

### HLS란

- HLS는 Apple에서 개발한 HTTP기반 ABR 스트리밍 프로토콜이다.
- HLS는 일반 웹 서버를 이용하여 콘텐츠를 저장, 배포할 수 있게 도와준다.

![image](https://ottverse.com/wp-content/uploads/2020/11/hls-apple-block-diagram.png)

- HLS 아키텍처
  - Encoder: 코덱에 대한 컨테이너 형식을 지정해준다. 기본적으로 fMP4 또는 MPEG-TS이다.
  - Packager
    - 비디오를 짧은 길이의 세그먼트로 자르는 것.
    - 자른 세그먼트들의 정보를 포함하여 이름, 위치, 재생 순서 등을 저장한 재생 목록 파일(m3u8)을 생성한다.
  - Web Server
    - 컨텐츠를 제공할 수 있는 웹 서버.
    - 웹 서버가 제공하는 것은 m3u8과 실체 콘텐츠이다.
  - Player/Client
    - HLS 스트림을 재생할 수 있는 플레이어.
    - 재생 목록을 다운로드하고, 재생 목록을 바탕으로 세그먼트를 연속적으로 다운로드, 화면에 렌더링하는 역할을 한다.

### HLS 패키징 방법

- ffmpeg
- Google의 Shaka-Packager
- bento4의 mp4hls

### HLS manifest

- 기본적으로 HLS의 매니페스트인 m3u8은 두 가지가 존재한다.
- master m3u8
  - master는 컨텐츠의 일부로 스트리밍 될 코덱이나, 비트레이트, 화질 등을 알려준다.
- content m3u8
  - content m3u8은 각 세그먼트를 나열한다.

### m3u8 예시

```m3u8
#EXTM3U
#EXT-X-MEDIA:URI="subtitle/lang_en/subtitle_index.m3u8",TYPE=SUBTITLES,GROUP-ID="subtitles",LANGUAGE="en",NAME="English",DEFAULT=YES,AUTOSELECT=YES
#EXT-X-STREAM-INF:BANDWIDTH=893752,AVERAGE-BANDWIDTH=560289,RESOLUTION=854x480,CODECS="avc1.4D401F,mp4a.40.2",SUBTITLES="subtitles"
media-4/index.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=1494976,AVERAGE-BANDWIDTH=891779,RESOLUTION=1280x720,CODECS="avc1.640028,mp4a.40.2",SUBTITLES="subtitles"
media-5/index.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=3262928,AVERAGE-BANDWIDTH=1894009,RESOLUTION=1920x1080,CODECS="avc1.640028,mp4a.40.2",SUBTITLES="subtitles"
media-6/index.m3u8
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=161304,RESOLUTION=854x480,CODECS="avc1.4D401F",URI="media-4/iframes.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=241392,RESOLUTION=1280x720,CODECS="avc1.640028",URI="media-5/iframes.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=532416,RESOLUTION=1920x1080,CODECS="avc1.640028",URI="media-6/iframes.m3u8"
```

```m3u8
#EXTM3U
#EXT-X-VERSION:4
#EXT-X-PLAYLIST-TYPE:VOD
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:4.000000,
segment-0.ts
#EXTINF:4.000000,
segment-1.ts
#EXTINF:4.000000,
segment-2.ts
#EXTINF:4.000000,
segment-3.ts
#EXTINF:4.000000,
segment-4.ts
```

## MPEG-DASH(Dynamic Adaptive Streaming Over HTTP)

### MPEG-DASH란

- MPEG에서 만든 HTTP 기반 ABR 스트리밍 프로토콜.
- 컨텐츠가 어떻게 조각으로 분할, 배열, 전달 될 지 MPD에 저장되어 있다.
- 클라이언트는 MPD를 바탕으로 재생을 진행한다.
- 클라이언트는 대역폭 조건과 버퍼 수준을 바탕으로 적응형 스트리밍을 할 수 있다.

### MPEG-DASH 동작 과정

![image](https://ottverse.com/wp-content/uploads/2021/03/image-16.png)

- 인코딩(트랜스코딩)된 컨텐츠는 패키저에 의해 지정된 기간의 작은 조각이나 청크로 분할된다.
- 패키저는 분할한 데이터를 바탕으로 MPD 형태로 manifest를 생성한다.
- 패키징된 컨텐츠와 MPD는 CDN을 통해 전달될 수 있도록 저장된다.
- 사용자가 재생을 누르면 MPD 파일을 서버에게 요청하고, 이를 분석한다.
- MPD를 분석한 후 정의된 순서대로 컨텐츠를 요청하고 디코딩한다.
- 클라이언트는 MPEG-DASH 호환 플레이어를 바탕으로 재생을 한다.

### MPEG-DASH 패키징 방법

- ffmpeg
- Goolge의 Shaka-Packager
- GPAC의 mp4box
- Bento4의 mp4dash

### MPD 예

```xml
<!--  MPD file Generated with GPAC version 0.5.1-DEV-rev5379  on 2014-09-10T13:23:18Z -->
<MPD xmlns="urn:mpeg:dash:schema:mpd:2011" minBufferTime="PT1.500000S" type="static" mediaPresentationDuration="PT0H9M56.46S" profiles="urn:mpeg:dash:profile:isoff-live:2011">
<ProgramInformation moreInformationURL="http://gpac.sourceforge.net">
<Title>dashed/BigBuckBunny_2s_simple_2014_05_09.mpd generated by GPAC</Title>
</ProgramInformation>
<Period duration="PT0H9M56.46S">
<AdaptationSet segmentAlignment="true" group="1" maxWidth="480" maxHeight="360" maxFrameRate="24" par="4:3">
<SegmentTemplate timescale="96" media="bunny_$Bandwidth$bps/BigBuckBunny_2s$Number$.m4s" startNumber="1" duration="192" initialization="bunny_$Bandwidth$bps/BigBuckBunny_2s_init.mp4"/>
<Representation id="854x480 595.0kbps" mimeType="video/mp4" codecs="avc1.42c01e" width="854" height="480" frameRate="24" sar="1:1" startWithSAP="1" bandwidth="595491"/>
<Representation id="1280x720 1.5Mbps" mimeType="video/mp4" codecs="avc1.42c01f" width="1280" height="720" frameRate="24" sar="1:1" startWithSAP="1" bandwidth="1546902"/>
<Representation id="1920x1080 2.1Mbps" mimeType="video/mp4" codecs="avc1.42c032" width="1920" height="1080" frameRate="24" sar="1:1" startWithSAP="1" bandwidth="2133691"/>
</AdaptationSet>
</Period>
</MPD>
```

## HLS VS MPEG-DASH

|                   Feature                  |             HLS             |                    MPEG-DASH                   |
|:------------------------------------------:|:---------------------------:|:----------------------------------------------:|
| Created by                                 |          Apple Inc.         |      A consortium of companies led by MPEG     |
| Support HTTP-based ABR streaming           |             Yes             |                       Yes                      |
| Supported by major CDNs                    |             Yes             |                       Yes                      |
| Security and Encryption                    |   Yes, via Apple Fairplay   | Yes, via Microsoft PlayReady & Google Widevine |
| Supports CENC (Common Encryption) and fmp4 |             Yes             |                       Yes                      |
| Native HTML5 Playback                      |   Only in Safari and Edge   |                   Yes via MSE                  |
| Supported by Safari browser                |             Yes             |                       No                       |
| Low Latency Playback                       |            LL-HLS           |                     LL-DASH                    |
| iOS support                                | Yes (only HLS is supported) |                       No                       |
| Advertising support                        |      Yes (VAST & VPAID)     |               Yes (VAST & VPAID)               |
| Supports H.264/AVC & HEVC                  |             Yes             |                       Yes                      |

