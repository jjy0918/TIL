# 3 클래스 설계: 모든 것과 연결되는 설계 기반

## 3.1 클래스 단위로 잘 동작하도록 설계하기

- 클래스 설계 시 가장 중요한 것은 클래스 단위로도 잘 동작하도록 설계하는 것이다.
- 클래스는 클래스 하나로도 잘 동작할 수 있게 설계해야 한다.
  - 헤드폰, 전자레인지 등의 전자 제품은 전원선만 연결하면 곧바로 사용 가능하며, 복잡한 초기 설정이나 다른 제품과의 결합과 상관 없이 동작한다.
  - 클래스도 전자 제품과 같이 별도의 복잡한 설정이나 다른 클래스와의 결합과 상관 없이 스스로 잘 동작해야 한다.
- 클래스는 마음대로 조작해서 클래스 전체가 고장 나는 일(버그) 없게 최소한의 조작 방법(메서드)만 외부에 공개해야 한다.

### 3.1.1 클래스의 구성 요소

- 클래스는 기본적으로 두 가지로 구성된다.
  - 인스턴스 변수
  - 메서드
- 잘 만들어진 클래스는 두 가지로 구성된다.
  - 인스턴스 변수
  - 인스턴스 변수에 잘못되 값이 할당되지 않게 막고, 정상적으로 조작하는 메서드
- 1장에서 보았던 데이터 클래스의 경우에만 인스턴스 변수만 가지고 있기 때문에 잘 만들어진 클래스가 아니다.
  - 데이터 클래스는 인스턴수 변수 조작이 다른 클래스에 구현되어 있기 때문에 연관성을 알아채기 어려워 코드 중복이 될 수 있다.
  - 인스턴수 변수의 초기화 역시 따로 해주어야 하고, 이러한 초기화 작업도 별도의 클래스가 따로 있어서 잘못된 값이 들어갈 수 있다.

### 3.1.2 모든 클래스가 갖추어야 하는 자기 방어 임무

- 클래스가 다른 클래스에 의존하여 초기화 및 유효성 검사를 해야 하는 경우 그 자체로는 안전하게 사용할 수 없기 때문에 미성숙한 클래스라고 할 수 있다.
- 클래스는 클래스 단위로도 잘 동작해야 하기 때문에 스스로 `자기 방어 임무`를 수행할 수 있어야 한다.
- 데이터 클래스의 경우에도 자기 방어 임무를 부여하여 스스로 할 수 있게 설계해야 한다.

## 3.2 성숙한 클래스로 성장시키는 설계 기법

### 3.2.1 생성자로 확실하게 정상적인 값 설정하기

- 데이터 클래스의 경우 디폴트 생성자를 이용하여 인스턴스를 생성하고, 이후에 따로 값을 할당하여 초기화 한다.
  - 인스턴스 생성 후 따로 값일 할당하기 전까지를 로우 데이터 객체라고 하며, 이떄 초기화되지 않은 상태를 유발하게 된다.
- 로우 데이터 객체를 방지하기 위해서는 클래스 인스턴스를 생성하는 시점에 확실하게 인스턴스 변수가 정상적인 값을 갖게 만들면 된다.
  - 이를 위해 적절한 초기화 로직을 생성자에 구현하면 된다.
  - 정상적인 값을 가지게 하기 위해서 매개변수로 잘못된 값이 전달되었는지 판단(유효성 검사)해야 한다.

```java
class Money {
    Money(int amount, Currency currency) {
        if (amount < 0 ) {
            throw new IllegalArgumentException("금액은 0 이상의 값을 지정해주세요");
        }

        if(currency == null) {
            throw new NullPointerException("통화 단위를 지정해 주세요.");
        }

        this.amount = amount;
        this.curreny = currency;
    }
}
```

### 3.2.2 계산 로직도 데이터를 가진 쪽에 구현하기

- 데이터 클래스와 같이 데이터를 가지고 있는 클래스와 데이터를 조작하는 로직이 클래스가 분리되어 있는 구조를 `응집도가 낮은 구조` 라고 한다.
- 응집도가 낮은 구조의 경우 여러 문제가 발생할 수 있다.
  - 이를 막기 위해서는 데이터를 가진 클래스가 스스로 할 수 있게 만들어야 한다.

```java
class Money {
    ...
    void add(int other) {
        amount += other;
    }
    ...
}
```

### 3.2.3 불변 변수로 만들어서 예상하지 못한 동작 막기

- 변수의 값이 계속해서 바뀌면, 값이 언제 변경되엇는지, 지금 값이 무엇인지 계속 신경 써야 한다.
- 이를 막기 위해서는 인스턴스 변수를 불면(immutable)으로 만들면 된다.

```java
class Money {
    final int amount;
    final Currency currency;

    Money(int amount, Currency currency) {
        ...
    }
    ...
}
```

### 3.2.4 변경하고 싶다면 새로운 인스턴스를 만들기

- 변수의 값을 불변으로 만들었지만, 변경하고 싶은 경우에는 새로운 인스턴스를 만들어주면 된다.
- 새로운 인스턴스로 만들어줄 경우 불변 값을 유지하면서도 값을 변경할 수 있다.

```java
class Money {
    ...
    Money add(int other) {
        int added = amount + other;
        return new Money(added, currency);
    }
    ...
}
```

### 3.2.5 메서드 매개변수와 지역 변수도 불변으로 만들기

- 매개변수의 경우에도 메소드 내에서 값이 변경될 위험기 있기 때문에 불변으로 만들어주는 것이 좋다.

```java
void doSomething(final int value) {
    ...
}
```

### 3.2.6 엉뚱한 값을 전달하지 않도록 하기

- 매개변수로 엉뚱한 값이 전달될 수 있다.
  - 특히 기본형으로 설정한 경우에 사용하는 부분에서 엉뚱한 값을 전달할 수 있다.
- 엉뚱한 값을 전달 받지 않기 위해서는 독자적인 자료형을 만들어 사용하면 된다.

```java
class Money {
    ...
    Money add(final Money other) {
        if(!currency.equals(other.currency)) {
            throw new IllegalArgumentException("통화 단위가 다릅니다.");
        }

        final int added = amount + other.amount;
        return new Money(added, currency);
    }
}
```

### 3.2.7 의미 없는 메서드 추가하지 않기

- 시스템 사용에 필요한 메서드만 정의하자

## 3.3  악마 퇴치 효과 검토하기

- 기존 데이터 클래스를 변경함에 따라 중복 코드, 수정 누락, 가독성 저하, 쓰레기 객체, 잘못된 값, 생각하지 못한 부수 효과, 값 전달 실수 라는 악마가 퇴치되었다.
- 클래스 설계란 인스턴스 변수가 잘못된 상태에 빠지지 않게 하기 위한 구조를 만드는 것이라 할 수 있다.
- 같은 데이터라 하더라도 메서드 매개변수, 지역 변수, static 변수는 위험에 빠질 수 있다.
- 새로 설계한 클래스와 같은 구조를 응집도가 높은 구조라 한다.
- 데이터와 그 데이터를 조작하는 로직을 하나의 클래스로 묶고, 필요한 절차만 외부에 공개하는 것을 `캠슐화` 라고 한다.

## 3.4 프로그램 구조의 문제 해결에 도움을 주는 디자인 패턴

- 응집도가 높은 구조로 만들거나, 잘못된 상태로부터 프로그램을 방어하는 등 프로그램 구조를 개선하느 설계 방법을 `디자인 패턴` 이라 한다.
- 디자인 패턴은 각각 다양한 효과를 발휘한다.
  - 완전 생성자: 잘못된 상태로부터 보호
  - 값 객체: 특정한 값과 관련된 로직의 응집도를 높임.
  - 전략(strategy): 조건 분기를 줄이고, 로직을 단순화함.
  - 정책(policy): 조건 분기를 단순화하고, 더 자유롭게 만듦.
  - 일급 컬렉션(First Class Collection): 값 객체의 일종으로 컬렉션과 관련된 로직의 응집도를 높임.
  - 스프라우트 클래스(Sprout Class): 기존 로직을 변경하지 않고, 안전하게 새로운 기능을 추가함.

### 3.4.1 완전 생성자(complete constructor)

- 완전 생성자는 잘못된 상태로부터 클래스를 보호하기 위한 디자인 패턴이다.
- 매개변수 없는 디폴트 생성자로 객체를 생성하고 이후에 값을 설정하는 것이 아니라 매개변수를 가진 생성자를 이용하며 잘못된 값이 들어이지 않도록 만든다.
- 인스턴스 변수에 final 수식자를 붙여서 불변으로 만들면 생성 후에도 잘못된 상태로부터 방어할 수 있다.

### 3.4.2 값 객체(value object)

- 값 객체란 값을 클래스(자료형)로 나타내는 디자인 패턴이다.
- 애플리케이션에서 사용하는 금액, 날짜, 주문 수 등을 값 객체로 나타내어 값 응집도가 높은 구조로 만들 수 있다.
  - 금액을 단순히 int가 아니라 별도의 클래스로 정의하여 사용하는 것이다.
- 값 객체와 완전 생성자는 얻을 수 있는 효과가 거의 비슷하다.
- 일반적으로 `값 객체 + 완전 생성자`는 객체 지향 설계에서 폭넑게 사용되는 기법이다.
  - 값 객체 + 완전 생성자를 활용하여 제약과 의도를 자료형으로 표현함과 동시에 안전한 코드를 작성할 수 있다.