# Chapter5 스트림 활용

## 5.1 필터링

- 스트림 인터페이스는 `filter` 메서드를 지원한다.
- filter 메서드는 프리디케이트를 인수로 받아서 프리디케이트와 일치하는 모든 요소를 포함한 스트림을 반환한다.
  - 프리디케이트는 boolean을 반환한다.
- 스트림 인터페이스는 고유 요소로 이루어진 스트림을 반환하는 `distinct` 메서드도 지원한다.
  - 고유 여부는 hashCode, equals 로 결정된다.

## 5.2 스트림 슬라이싱

- 스트림에서는 takeWhile, dropWhile 을 이용하여 슬라이싱을 제공한다.
  - takeWhile은 프리디케이트를 받으며, false가 반환되는 순간 반복을 중지한다.
  - dropWhile도 프리디케이트를 받으며, false가 나오는 순간 그 이전 데이터를 버리고 남은 데이터를 반환한다.
- limit 메서드를 이용하여 주어진 값 이하의 크기를 갖는 새로운 스트림을 반환한다.
  - limit은 쇼트 서킷을 활용하여, n개를 반환하면 모든 요소를 반복하지 않아도 스트림을 반환한다. 
- skip 메서드를 이용하여 처음 n개 요소를 제외한 스트림을 반환한다.

## 5.3 매핑

- map 메서드는 인수로 제공되는 함수를 각 요소에 적용하여 새로운 요소로 매핑(변환)시켜준다.
- flatmap 메서드를 이용하여 스트림의 각 값을 다른 스트림으로 만든 다음 모든 스트림을 하나의 스트림으로 연결시켜준다.

## 5.4 검색과 매칭

- anyMatch는 프리디케이트를 이용하여 하나라도 true 값이 있는지 확인하는 최종 연산이다.
- allMatch는 프리디케이트를 이용하여 모든 요소가 true 인지 확인하는 최종 연산이다.
- noneMatch는 프리디케이트를 이용하여 모든 요소가 false 인지 확인하는 최종 연산이다.
- anyMatch, allMatch, noneMatch는 `쇼트 서킷`을 활용한다.
  - 자바의 &&, || 와 같이 전체가 처리되지 않아도 결과를 반환한다.
  - 모든 스트림의 요소를 처리하지 않고도 결과를 반환한다.
- findAny 메서드는 임의의 요소를 반환한다.
   - findAny는 병렬 처리 시 반환 순서가 상관 없는 경우 유용하게 사용할 수 있다.
- findFirst 메서드는 논리적인 아이템 순서가 정해져 있을 때 첫 번째 요소를 반환한다.
  - findFirst는 병렬 처리할 때에는 순서보장이 어려워 사용되지 않는다.

## 5.5 리듀싱

- 리듀싱 연산이란 모든 스트림 요소를 처리해서 값으로 도출하는 것을 의미한다.
  - ex) 메뉴의 모든 칼로리의 합
- 리듀싱 연산 외에는 Optional 객체를 반환하거나 Collection으로 반환한다.

## 5.5.1 요소의 합

```java
// 기본 방법
int sum = 0;
for(int x: numbers) {
  sum += x;
}

// 리듀싱 이용
int sum = numbers.stream().reduce(0, (a, b) -> a + b);
```

- 리듀싱은 (초깃값, BinaryOperator)를 받아 처리한다.
  - BinaryOperator에서는 (요소의 처리 값, 다음 원소) 형태를 받아 처리한다.
  - 위 예시의 경우 리스트에 4, 5, 3, 9가 들어 있고 초깃값이 0 이라면 (0, 4) -> (4, 5) -> (9, 3) -> (12, 9) -> 21 형태로 연산한다.
- 초깃값 없이 BinaryOperator만 받아 처리하는 reduce도 오버로딩되어 정의되어 있다.
  - 초깃값이 없기 때문에 스트림의 원소가 없는 경우 아무 값도 반환이 안되기 떄문에 Optional로 반환된다.


### reduce 메서드의 장점과 병렬화

- reduce를 이용할 경우 내부 반복이 추상화되기 때문에 병렬로 실행할 수 있다.
- 일반적인 경우 병렬화할 때 스레드간 소모적인 경쟁때문에 불필요한 자원이 낭비된다.

### 스트림 연산: 상태 없음과 상태 있음

- map, filter 등은 스트림에서 요소를 받아 출력 스트림으로 보내기 때문에 내부 상태를 갖지 않는 연산이다.
- reduce, sum, max 등은 연산 결과를 누적할 내부 상태가 필요하고 내부 상태는 한정된 크기를 가지게 된다.
- sorted, distinct 등은 filter나 map 처럼 스트림을 받아 스트림을 출력하는 형태이지만, 과거 이력을 알고 있어야 한다.
  - 이러한 요소들은 모든 요소가 버퍼에 추가되어 있어야 하기 때문에 내부 상태를 갖는 연산이라 한다.
  - 입력이 무한이라면 문제가 발생할 수 있다.

## 5.7 숫자형 스트림

### 5.7.1 기본형 특화 스트림

- 자바8 에서는 박싱 비용을 피하기 위해 세 가지 기본형 특화 스트림을 제공한다.
  - IntStream, DoubleStream, LongStream
- 각 기본형 특화 스트림은 각자의 인터페이스에서 sum, max 와 같은 숫자 관련 리듀싱 연산 수행 메서드를 제공한다.
- mapToInt, mapToDobule, mapToLong 메서드는 map과 같은 기능을 수행하지만, Stream<T>가 아니라 특화 스트림을 반환한다.
- 기본형 특화 스트림의 경우 일반 스트림 형태(Stream<T>) 로 변환할 수 있는 기능을 제공한다.
  - Stream<Integer> stream = intStream.boxed();
- 기본형 특화 스트림의 반환 값 역시 기본형 특화 Optional을 별도로 제공한다.
  - OptionalInt, OptionalDouble, OptionalLong

### 5.7.2 숫자 범위

- IntStream과 LongStream의 경우 숫자 범위를 간단하게 만들 수 있는 메서드를 제공한다.
- range는 첫 번째 매개변수 부터 시작하여 두 번째 매개변수 전까지 범위를 만들어준다.
  - range(2, 10) --> 2, 3, 4, ... 9
- rangeClosed는 첫 번째 매개변수부터 시작하여 두 번째 매개변수 까지 범위를 만들어준다.
  - rangeClosed(2, 10) --> 2, 3, 4, ... 9, 10

## 5.8 스트림 만들기

### 5.8.1 값으로 스트림 만들기

- 정적 메소드인 `Stream.of`를 이용하여 스트림을 만들 수 있다.
  - ex) Stream.of("Modern", "Java", "In", "Action");
- `Stream.empty()`를 이용하여 빈 스트림도 생성 가능하다.

### 5.8.2 null이 될 수 있는 객체로 스트림 만들기

- 자바9 에서는 `Stream.ofNullable` 메서드를 통해 null이 될 수 있는 개체로 스트림을 만들 수 있다.


### 5.8.3 배열로 스트림 만들기

- `Arrays.stream`을 통해 배열을 매개변수로 받아 스트림으로 만들 수 있다.

### 5.8.4 파일로 스트림 만들기

- 자바의 NIO API도 스트림 API를 활용할 수 있도록 업데이트 되었다.
- Stream 인터페이스는 AutoCloseable 인터페이스를 구현했기 때문에 try-with-resources 를 통해 파일 자원을 자동으로 관리해준다.

### 5.8.5 함수로 무한 스트림 만들기

- Stream.iterate와 Stream.generate 를 이용하여 무한 스트림을 만들 수 있다.
- iterate와 generate에서 만든 스트림은 요청할 때마다 주어진 함수를 이용하여 값을 만든다.
  - iterate는 기존 연산 결과에 의존하여 순차적으로 연산을 수행한다.
    - Java9 에서는 프레디케이트를 지원하여 코드 중단을 구현할 수 있다.
  - generate는 기존 연산과 상관 없이 새로운 값을 생성한다.
- 일반적으로는 무한 스트림은 limit 함수와 연결하여 사용한다.
- iterate는 각 단계에서 값을 가지지만 객체를 매번 생성하기 때문에 불변 상태를 유지하지만, generate는 값을 가지도록 변경할 수는 있지만 매번 객체를 생성하는 것이 아니기 떄문에 주의해야 한다.

## 5.9 정리

- 스트림 API를 이용하면 복잡한 데이터 처리 질의를 표현할 수 있다.
- filter, distinct, takeWhile, dropWhile, skip, limit 메서드로 스트림을 필터링하거나 자를 수 있다.
- 소스가 정렬되어 있다는 사실을 알고 있을 때 takeWhile과 dropWhile 메서드를 효과적으로 사용할 수 있다.
- map, flatMap 메서드로 스트림의 요소를 추출하거나 변환할 수 있다.
- findFIrst, findAny 메서드로 스트림의 요소를 검색할 수 있다.
- allMatch, noneMatch, anyMatch 메서드를 이요하여 주어진 프리디케이트와 일치하는 요소를 스트림에서 검색할 수 있다.
- 쇼트 서킷을 제공하는 메서드는 결과를 찾는 즉시 반환하기 때문에 전체 스트림을 처리하지 않는다.
- reduce 메서드로 스트림의 모든 요소를 반복 조합하여 값을 도출할 수 있다.
- filter, map 등은 상태를 저장하지 않는 상태 없는 연산이며 reduce 같은 연산은 값을 계싼하는 데 필요한 상태를 저장한다.
- sorted, distinct 등의 메서드는 새로운 스트림을 반환하기 위해 모든 요소를 버퍼에 저장해야 하기 떄문에 상태 있는 연산이라고 한다.
- IntStream, DoubleStream, LongStream은 기본형 특화 스트림이다.
- 컬렉션뿐 아니라 값, 배열, 파일, iterate, generate 메서드로도 스트림을 만들 수 있다.
- 무한한 개수의 요소를 가진 스트림을 무한 스트림이라 한다.
