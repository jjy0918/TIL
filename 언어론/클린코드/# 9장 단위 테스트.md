# 9장 단위 테스트

## TDD법칙 세 가지

- 1. 실패하는 단위 테스트를 작성할 때까지 실제 코드를 작성하지 않는다.
- 2. 컴파일은 실패하지 않으면서 실행이 실패하는 정도로만 단위 테스트를 작성한다.
- 3. 현재 실패하는 테스트를 통과할 정도로만 실제 코드를 작성한다.
- 위 세 가지 규칙을 따르면 개발과 테스트가 대략 30초 주기로 묶인다.
  - 테스트 코드와 실제 코드가 함께 나오며, 테스트 코드가 실제 코드보다 불과 몇 초 전에 나온다.
- TDD를 하면 매일 수십 개의 테스트 케이스가 나오고, 이러한 방식을 지속하면 사실상 전부를 테스트하는 테스트 케이스가 나온다.
- 방대한 테스트 케이스는 방대한 코드가 되고, 이것은 심각한 관리 문제를 유발하기도 한다.

## 깨끗한 테스트 코드 유지하기

- 단순히 돌아가기만 하는 더러운 테스트 코드는 오히려 테스트를 안 하는 것 보다 더 못하다.
  - 비즈니스 로직이 변경 되면, 테스트도 당연히 변경되어야 한다.
  - 더러운 테스트 코드는 변경이 어렵기 때문에 실제 코드를 작성하는 시간보다 테스트 코드 변경 시간이 더 오래 걸리게 된다.
  - 테스트 코드 관리가 어려워지니, 점점 테스트 코드 작성 하지 않는 방향으로 가게 되고 결함율은 높아진다.
- 테스트 코드를 깨끗하게 작성했다면, 이러한 문제점은 발생하지 않고 프로그램의 결함도 없어진다.
- 테스트 코드는 실제 코드 못지 않게 중요하기 때문에 실제 코드 못지 않게 깨긌하게 짜야 한다.
- 테스트 케이스가 없다면, 실제 코드를 유연하게 만드는 버팀목이 사라지는 것이다.
  - 코드의 유연성, 유지보수성, 재사용성을 제공하는 버팀목이 `단위 테스트`다.
  - 테스트 케이스가 있기 때문에 변경이 두렵지 않게 된다.

## 깨끗한 테스트 코드

- 깨끗한 테스트 코드를 만들기 위해서는 세 가지가 필요하다.
  - 1. 가독성, 2. 가독성, 3. 가독성
- 테스트 코드의 가독성을 높이기 위해서는 여느 코드와 마찬가지로 명료성, 단순성, 풍부한 표현력이 필요하다.
- BUILD-OPERATE-CHECK 패턴을 이용하면 테스트 코드를 가독성 있게 작성할 수 있다.
  - BUILD: 테스트 자료를 만든다.
  - OPERATE: 테스트 자료를 조작한다.
  - CHECK: 조작한 결과가 올바른지 확인한다.
  - 테스트 코드는 본론에 돌입해 진짜 필요한 자료 유형과 함수만 사용한다.

### 도메인에 특화된 테스트 언어

- 도메인 특화된 언어(DSL)에 대한 테스트는 DSL 위에 함수와 유틸리티를 구현한 후 해당 함수와 유틸리티에 대한 테스트를 진행한다.

### 이중 표준

- 테스트 API 코드에 적용하는 표쥰은 실제 코드에 적용하는 표쥰과 확실히 다르다.
- 단순하고, 간결하고, 표현력이 풍부해야 하지만, 실제 코드만큼 효율적일 필요는 없다.
- 실제로 코드 표준에는 맞지 않더라도, 의미를 빠르게 판단할 수 있다면 테스트코드에서는 사용할 수 있다.
- 테스트에서는 성능에 대한 고려가 필요 없다.

```java
@Test
public void turnOnLoTempAlarmAtThreashold() {
    hw.setTemp(WAY_TOO_COLD);
    controller.tic();
    assertTrue(hw.heaterState());   // 눈에 잘 안들어온다.
    ...
}

@Test
public void turnOnLoTempAlarmAtThreashold() {
    wayTooCold();
    assertEquals("HBchL", hw.getState());   // 그릇된 방식이지만, 알아보기 쉽다.
    ...
}

```

### 테스트 당 assert 하나

- JUnit으로 테스트 코드를 짤 때는 함수마다 assert 문을 단 하나만 사용해야 한다고 주장하는 사람들이 있다.
- assert 문이 단 하나인 함수는 결론이 하나라서 코드를 이해하기 쉽고 빠르다.
- assert 문 하나가 되도록 작성하게 되면, 중복 코드가 많아지기 때문에 template 패턴을 사용하는 것이 좋다.
  - given/when 부분을 부모 클래스에 두고 then 부분을 자식 클래스에 두면 된다.
  - 또는 @Before 함수에 given/when 부분을 넣는다.
- 단일 assert 문을 지키면 좋지만, 무조건 지켜야하는 것은 아니다.

### 테스트 당 개념 하나

- 테스트 하나에 이것저것 잡다한 개념을 연속으로 테스트하는 긴 함수는 피하라.

## F.I.R.S.T

- 깨끗한 테스트는 다음 다섯 가지 규칙을 따른다.
- 1. F(Fash): 테스트는 빨라야 한다.
- 2. I(Independent): 각 테스트는 서로 의존하면 안 된다.
  - 각 테스트는 독립적으로 그리고 어떤 순서로 실행해도 괜찮아야 한다.
  - 테스트가 서로에게 의존하면 하나가 실패할 때 나머지도 잇달아 실패하기 때문에 원인 진단이 어려워진다.
- 3. R(Repetable): 테스트는 어떤 환경에서도 반복 가능해야 한다.
- 4. S(Self-Validating): 테스트는 부울(bool) 값으로 결과를 내야 한다.
  - 성공 아니면 실패다.
  - 테스트가 스스로 성공과 실패를 가늠하지 않는다면, 판단은 주관적이 되며 지루한 수작업 평가가 필요하게 된다.
- 5. T(Timely): 테스트는 적시에 작성해야 한다.
  - 단위 테스트는 테스트하려는 실제 코드를 구현하기 직전에 구현한다.
  - 실제 코드를 구현한 다음 테스트 코드를 만들면 실제 코드가 테스트하기 어렵다는 사실을 발견할지도 모른다.